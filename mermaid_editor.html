<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Diagram Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-elevated: #252525;
            --accent-primary: #C26D4D;
            --accent-glow: rgba(194, 109, 77, 0.3);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --border-subtle: #333333;
            --grid-color: #222222;
        }

        * {
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--border-subtle) var(--bg-dark);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            background-image:
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Prevent body scroll, let containers scroll */
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 10px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            flex-shrink: 0;
        }

        .workspace {
            display: flex;
            gap: 15px;
            flex: 1;
            min-height: 0;
            /* Critical for flex nesting */
        }

        .panel {
            background: rgba(30, 30, 30, 0.75);
            /* Slightly more opaque */
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        /* Editor Side - Compact */
        .editor-section {
            width: 350px;
            min-width: 300px;
            padding: 15px;
            gap: 12px;
            flex-shrink: 0;
        }

        /* Preview Side - Maximized */
        .preview-section {
            flex: 1;
            position: relative;
            padding: 0;
            overflow: hidden;
            /* Internal scrolling */
        }

        input[type="text"],
        textarea {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-main);
            border-radius: 8px;
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        textarea {
            flex: 1;
            resize: none;
            line-height: 1.5;
        }

        /* Preview Container */
        #preview-container {
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            /* Dark background to match aesthetic */
            border-radius: 12px;
            overflow: auto;
            display: grid;
            place-items: center;
            /* Center content */
            position: relative;
            /* Grid background for preview area specifically */
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .mermaid {
            padding: 40px;
            /* Allow it to grow natively */
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #252525;
            border: 1px solid var(--border-subtle);
            padding: 4px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .zoom-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Button Grid */
        .action-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        button {
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
            grid-column: 1 / -1;
            padding: 12px;
            font-size: 0.95em;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: #ccc;
            border: 1px solid transparent;
        }

        .btn-secondary:hover {
            background: #333;
            border-color: #555;
            color: white;
        }

        /* History Strip at bottom of editor */
        .history-section {
            margin-top: auto;
            border-top: 1px solid var(--border-subtle);
            padding-top: 12px;
        }

        .history-title {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .saved-strip {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .saved-item {
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .saved-item:hover {
            background: var(--bg-elevated);
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 style="margin:0; font-size: 1.2em; color: white; display:flex; align-items:center; gap: 10px;">
                <span style="font-size:1.2em;">üé®</span> Mermaid Editor
                <span
                    style="font-size:0.6em; background:var(--bg-elevated); padding:2px 6px; border-radius:4px; border:1px solid var(--border-subtle);">v2.2
                    (Ultra)</span>
            </h1>
            <a href="https://github.com/PiyushVerma24/mermaid-diagram-editor1" target="_blank"
                style="color:#666; text-decoration:none; font-size:0.8em;">GitHub</a>
        </div>

        <div class="workspace">
            <div class="panel editor-section">
                <input type="text" id="diagram-name" placeholder="Name your diagram..." value="My Awesome Diagram">
                <textarea id="mermaid-input" spellcheck="false" placeholder="Enter Mermaid code...">graph TD
    style Start fill:#C26D4D,stroke:#fff,stroke-width:2px,color:#fff
    style End fill:#252525,stroke:#C26D4D,stroke-width:2px,color:#fff
    
    Start(Start New Project) -->|Design| B{Is it Awesome?}
    B -->|Yes| C[Deploy to Vercel]
    
    subgraph Iteration
        B -->|No| D[Refine UI]
        D --> B
    end
    
    C --> End(Success)</textarea>

                <div class="action-row">
                    <button class="btn-primary" onclick="renderDiagram()">
                        ‚ö° Render Diagram
                    </button>
                    <button class="btn-secondary" onclick="saveAsPNG()">üì∏ PNG (HD)</button>
                    <button class="btn-secondary" onclick="saveAsPDF()">üìÑ PDF</button>
                    <button class="btn-secondary" onclick="saveAsSVG()">‚öõÔ∏è SVG</button>
                    <button class="btn-secondary" onclick="copyToClipboard()">üìã Copy</button>
                </div>

                <div class="history-section">
                    <div class="history-title">Recent History</div>
                    <div class="saved-strip" id="saved-diagrams-list"></div>
                </div>
            </div>

            <div class="panel preview-section">
                <div id="preview-container">
                    <div id="preview"></div>
                </div>
                <!-- Independent Overlay for Zoom -->
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
                    <span id="zoom-level"
                        style="color:var(--text-muted); font-size:0.8em; font-family:monospace; min-width: 40px; text-align:center;">100%</span>
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Init Mermaid with a theme that works well on Dark Backgrounds
        mermaid.initialize({
            startOnLoad: false,
            // 'base' theme is good for customization
            theme: 'base',
            themeVariables: {
                primaryColor: '#252525',
                primaryTextColor: '#fff',
                primaryBorderColor: '#C26D4D',
                lineColor: '#a0a0a0',
                secondaryColor: '#1e1e1e',
                tertiaryColor: '#121212',
                fontFamily: 'Inter'
            },
            securityLevel: 'loose'
        });

        let currentZoom = 1.0;

        function renderDiagram() {
            const inputVal = document.getElementById('mermaid-input').value;
            const previewDiv = document.getElementById('preview');

            if (!inputVal.trim()) {
                previewDiv.innerHTML = '<p style="color:#666">Waiting for code...</p>';
                return;
            }

            const id = 'mermaid-' + Date.now();
            // Clear previous and prep new container
            previewDiv.innerHTML = `<div class="mermaid" id="${id}" style="transform-origin: center center;">${inputVal}</div>`;

            // Re-apply zoom immediately
            applyZoom();

            mermaid.run({
                nodes: [document.getElementById(id)]
            }).then(() => {
                saveToHistory(inputVal);
            }).catch(err => {
                previewDiv.innerHTML = `<div style="color:var(--danger); padding:20px; text-align:center;">
                    Error in Syntax<br><span style="font-size:0.8em; opacity:0.7">${err.message}</span>
                </div>`;
            });
        }

        function zoomIn() { currentZoom += 0.1; applyZoom(); }
        function zoomOut() { if (currentZoom > 0.2) currentZoom -= 0.1; applyZoom(); }

        function applyZoom() {
            const el = document.querySelector('.mermaid');
            if (el) el.style.transform = `scale(${currentZoom})`;
            document.getElementById('zoom-level').innerText = Math.round(currentZoom * 100) + '%';
        }

        // --- EXPORT FUNCTIONS ---

        // 1. PDF Export (WYSIWYG - Dark Mode)
        function saveAsPDF() {
            const svg = document.querySelector('.mermaid svg');
            if (!svg) return alert("Render diagram first!");

            const name = document.getElementById('diagram-name').value || 'diagram';

            // Capture the SVG as a canvas with DARK background
            // We use a dark background canvas to match the 'Futuristic' look in the PDF
            // This fixes the "Invisible PDF" issue where white text was on white background.
            drawSvgToCanvas(svg, 2, '#1a1a1a', (canvas) => {
                // Use jsPDF for better control
                // Convert canvas to image data
                const imgData = canvas.toDataURL('image/jpeg', 1.0);

                // Calculate PDF Page size based on image aspect ratio
                // 1px = 0.75 point approx, 0.26mm
                const imgWidth = canvas.width * 0.264583; // px to mm
                const imgHeight = canvas.height * 0.264583;

                // Choose orientation
                const orientation = imgWidth > imgHeight ? 'l' : 'p';

                // Create PDF matching the image size (plus margin)
                // This ensures "Visibility" - no cutting off
                window.html2pdf().set({
                    margin: 5,
                    filename: name + '.pdf',
                    image: { type: 'jpeg', quality: 1.0 },
                    jsPDF: { unit: 'mm', format: [imgHeight + 20, imgWidth + 20], orientation: orientation }
                }).from(canvas).save();
            });
        }

        // 2. PNG Export (High Quality)
        function saveAsPNG() {
            const svg = document.querySelector('.mermaid svg');
            if (!svg) return alert("Render first!");

            // Scale 4x for High Res
            drawSvgToCanvas(svg, 4, '#1a1a1a', (canvas) => {
                const a = document.createElement('a');
                a.download = (document.getElementById('diagram-name').value || 'diagram') + '.png';
                a.href = canvas.toDataURL('image/png');
                a.click();
            });
        }

        // Helper: SVGs to Canvas
        function drawSvgToCanvas(svgElement, scale = 2, bgColor = null, callback) {
            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svgElement);

            const img = new Image();
            // Encode safely for base64 inclusion
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));

            img.onload = function () {
                const canvas = document.createElement('canvas');
                const bbox = svgElement.getBoundingClientRect();

                // Use natural dims but scaled by zoom inverse to get 'true' size
                const nativeW = bbox.width / currentZoom;
                const nativeH = bbox.height / currentZoom;

                canvas.width = nativeW * scale;
                canvas.height = nativeH * scale;

                const ctx = canvas.getContext('2d');
                if (bgColor) {
                    ctx.fillStyle = bgColor;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }

                // Draw the image
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                callback(canvas);
            };

            img.onerror = function (e) {
                console.error("SVG Load Error", e);
                alert("Error processing diagram for export.");
            };
        }

        function saveAsSVG() {
            const svg = document.querySelector('.mermaid svg');
            if (!svg) return;
            const serializer = new XMLSerializer();
            const source = serializer.serializeToString(svg);
            const blob = new Blob([source], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (document.getElementById('diagram-name').value || 'diagram') + ".svg";
            a.click();
        }

        function copyToClipboard() {
            const code = document.getElementById('mermaid-input').value;
            navigator.clipboard.writeText(code);
            alert("Mermaid code copied!");
        }

        // History Setup
        function loadHistory() { try { return JSON.parse(localStorage.getItem('mermaidHistory')) || []; } catch (e) { return []; } }
        function saveToHistory(code) {
            const name = document.getElementById('diagram-name').value;
            let hist = loadHistory();
            if (hist.length > 0 && hist[0].code === code) return;
            hist.unshift({ name, code, time: Date.now() });
            if (hist.length > 20) hist = hist.slice(0, 20);
            localStorage.setItem('mermaidHistory', JSON.stringify(hist));
            renderHistoryStrip();
        }
        function renderHistoryStrip() {
            const hist = loadHistory();
            const el = document.getElementById('saved-diagrams-list');
            el.innerHTML = hist.map((h, i) => `
                <div class="saved-item" onclick="loadItem(${i})">
                    <span>${h.name}</span>
                    <span style="opacity:0.5; font-size:0.9em">Load</span>
                </div>
            `).join('');
        }
        function loadItem(i) {
            const h = loadHistory();
            document.getElementById('mermaid-input').value = h[i].code;
            document.getElementById('diagram-name').value = h[i].name;
            renderDiagram();
        }

        // Start
        setTimeout(() => { renderHistoryStrip(); renderDiagram(); }, 500);

        let timeout;
        document.getElementById('mermaid-input').addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(renderDiagram, 800);
        });
    </script>
</body>

</html>