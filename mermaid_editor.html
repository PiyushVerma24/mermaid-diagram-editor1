<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Diagram Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-elevated: #252525;
            --accent-primary: #C26D4D;
            --accent-glow: rgba(194, 109, 77, 0.3);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --border-subtle: #333333;
            --grid-color: #222222;
            --success: #3dbb67;
            --danger: #e24a4a;
        }

        * {
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--border-subtle) var(--bg-dark);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            background-image:
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            gap: 15px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }

        .workspace {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .panel {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .editor-section {
            grid-column: 1 / 2;
            gap: 15px;
        }

        .preview-section {
            grid-column: 2 / 3;
            position: relative;
        }

        input[type="text"],
        textarea {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-main);
            border-radius: 8px;
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
        }

        textarea {
            flex: 1;
            resize: none;
            font-size: 13px;
        }

        /* Improved Preview Container */
        #preview-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            overflow: auto;
            /* Allow scrolling */
            display: flex;
            align-items: flex-start;
            /* Top align for natural growth */
            justify-content: center;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.05);
            padding: 40px;
        }

        .mermaid {
            /* Ensure it occupies space needed */
            min-width: 100%;
            display: flex;
            justify-content: center;
        }

        /* Zoom Overlay */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            padding: 5px 15px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .zoom-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.5em;
            line-height: 1;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
        }

        .zoom-btn:hover {
            color: var(--accent-primary);
        }

        button {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: white;
            border: 1px solid var(--border-subtle);
        }

        .btn-secondary:hover {
            background: #333;
        }

        .saved-strip {
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 10px;
            display: flex;
            gap: 15px;
            overflow-x: auto;
            height: 80px;
            align-items: center;
        }

        .saved-item {
            min-width: 160px;
            background: var(--bg-elevated);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8em;
            color: var(--text-muted);
            border: 1px solid transparent;
        }

        .saved-item:hover {
            background: #2a2a2a;
            border-color: var(--accent-primary);
            color: white;
        }

        @media (max-width: 900px) {
            .workspace {
                grid-template-columns: 1fr;
            }

            .container {
                height: auto;
            }

            #preview-container {
                min-height: 500px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1
                style="margin:0; font-size: 1.4em; background: linear-gradient(90deg, #fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                Mermaid Editor <span
                    style="font-size:0.5em; vertical-align:middle; border:1px solid #333; padding:2px 6px; border-radius:4px; color: var(--accent-primary);">v2.1</span>
            </h1>
            <a href="https://github.com/PiyushVerma24/mermaid-diagram-editor1" target="_blank"
                style="color:#666; text-decoration:none; font-size:0.8em;">GitHub</a>
        </div>

        <div class="workspace">
            <div class="panel editor-section">
                <input type="text" id="diagram-name" placeholder="Untitled Diagram" value="My Diagram">
                <textarea id="mermaid-input" spellcheck="false" placeholder="Enter Mermaid code...">sequenceDiagram
    autonumber
    participant U as User
    participant S as System
    
    note right of U: Visualizing Future UI
    U->>S: Request Data
    S-->>U: Return JSON
    
    rect rgb(240, 240, 240)
    note right of S: Processing
    S->>S: Internal Validations
    end</textarea>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn-primary" onclick="renderDiagram()"
                        style="grid-column: 1 / -1; display:flex; justify-content:center; align-items:center; gap:8px;">
                        ‚ö° Render
                    </button>
                    <button class="btn-secondary" onclick="saveAsPNG()">üì∏ PNG</button>
                    <button class="btn-secondary" onclick="saveAsPDF()">üìÑ PDF</button>
                    <button class="btn-secondary" onclick="saveAsSVG()">‚öõÔ∏è SVG</button>
                    <button class="btn-secondary" onclick="copyToClipboard()">üìã Copy</button>
                </div>
            </div>

            <div class="panel preview-section">
                <div id="preview-container">
                    <div id="preview">
                        <p style="color: #999;">Loading...</p>
                    </div>
                    <!-- Moved Zoom into container overlay -->
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
                        <span id="zoom-level"
                            style="color:white; font-size:0.9em; font-family:'JetBrains Mono', monospace;">100%</span>
                        <button class="zoom-btn" onclick="zoomIn()">+</button>
                    </div>
                </div>
            </div>

            <div class="saved-strip" id="saved-diagrams-list"></div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            logLevel: 'error',
            fontFamily: 'Inter, sans-serif'
        });

        let currentZoom = 1.0;
        let mermaidCode = '';

        function renderDiagram() {
            const inputVal = document.getElementById('mermaid-input').value.trim();
            mermaidCode = inputVal;
            const previewDiv = document.getElementById('preview');

            if (!mermaidCode) {
                previewDiv.innerHTML = '<p style="color: #999;">Enter Mermaid code</p>';
                return;
            }

            const id = 'mermaid-' + Date.now();
            // Apply zoom inline
            previewDiv.innerHTML = `<div class="mermaid" id="${id}" style="transform: scale(${currentZoom}); transform-origin: top center; transition: transform 0.2s;">${mermaidCode}</div>`;

            mermaid.run({
                nodes: [document.getElementById(id)]
            }).catch(err => {
                previewDiv.innerHTML = `<div style="color: var(--danger); padding: 20px;">Syntax Error: ${err.message}</div>`;
            });

            saveToHistory(mermaidCode);
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.1, 5.0);
            applyZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.1, 0.2);
            applyZoom();
        }

        function applyZoom() {
            const el = document.querySelector('.mermaid');
            if (el) {
                el.style.transform = `scale(${currentZoom})`;
            }
            document.getElementById('zoom-level').textContent = Math.round(currentZoom * 100) + '%';
        }

        // Improved PDF Export
        function saveAsPDF() {
            const svg = document.querySelector('.mermaid svg');
            if (!svg) return alert('Please render diagram first');

            const name = document.getElementById('diagram-name').value || 'diagram';

            // Clone the SVG to manipulate it for PDF
            const clone = svg.cloneNode(true);

            // Get accurate dimensions from SVG bbox
            const bbox = svg.getBoundingClientRect();
            // We use the natural size / zoom level to get true resolution
            // But for PDF we want standard DPI approx
            let width = bbox.width / currentZoom;
            let height = bbox.height / currentZoom;

            // Force white background on SVG for PDF (since theme is transparent)
            clone.style.backgroundColor = 'white';
            clone.setAttribute('width', width);
            clone.setAttribute('height', height);

            // Create a temporary container off-screen
            const container = document.createElement('div');
            container.style.padding = '20px';
            container.style.background = 'white';
            container.style.width = (width + 40) + 'px';
            container.appendChild(clone);

            container.style.position = 'fixed';
            container.style.top = '-10000px';
            container.style.left = '-10000px';
            document.body.appendChild(container);

            const opt = {
                margin: 10,
                filename: name + '.pdf',
                image: { type: 'jpeg', quality: 1.0 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: width > height ? 'landscape' : 'portrait' }
            };

            html2pdf().set(opt).from(container).save().then(() => {
                document.body.removeChild(container);
            }).catch(err => {
                console.error(err);
                alert('PDF Generation failed. Try saving as PNG instead.');
                document.body.removeChild(container);
            });
        }

        // PNG Export with High Res
        function saveAsPNG() {
            const svg = document.querySelector('.mermaid svg');
            if (!svg) return alert('Render first');

            const serializer = new XMLSerializer();
            const source = serializer.serializeToString(svg);
            const name = document.getElementById('diagram-name').value || 'diagram';

            const img = new Image();
            img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(source);

            img.onload = function () {
                const canvas = document.createElement('canvas');
                // Capture at high resolution (3x)
                const scale = 3;
                // Use un-zoomed dimensions for the base
                const bbox = svg.getBoundingClientRect();
                const w = bbox.width / currentZoom;
                const h = bbox.height / currentZoom;

                canvas.width = w * scale;
                canvas.height = h * scale;

                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "white"; // White BG
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                const a = document.createElement('a');
                a.download = name + '.png';
                a.href = canvas.toDataURL('image/png');
                a.click();
            };
        }

        function saveAsSVG() {
            const svg = document.querySelector('.mermaid svg');
            if (!svg) return;
            const serializer = new XMLSerializer();
            const source = serializer.serializeToString(svg);
            const name = document.getElementById('diagram-name').value || 'diagram';
            const blob = new Blob([source], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name + ".svg";
            a.click();
        }

        function copyToClipboard() {
            const code = document.getElementById('mermaid-input').value;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.querySelector('button[onclick="copyToClipboard()"]');
                const original = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                setTimeout(() => btn.innerHTML = original, 2000);
            });
        }

        // History Management
        function loadHistory() {
            try { return JSON.parse(localStorage.getItem('mermaidHistory')) || []; }
            catch (e) { return []; }
        }

        function saveToHistory(code) {
            let hist = loadHistory();
            const name = document.getElementById('diagram-name').value;
            // Dedupe
            if (hist.length > 0 && hist[0].code === code) return;
            hist.unshift({ name, code, time: Date.now() });
            if (hist.length > 10) hist.pop();
            localStorage.setItem('mermaidHistory', JSON.stringify(hist));
            renderHistoryStrip();
        }

        function renderHistoryStrip() {
            const hist = loadHistory();
            const strip = document.getElementById('saved-diagrams-list');
            if (hist.length === 0) {
                strip.innerHTML = '<span style="color:#666; font-size:0.8em; padding-left:10px;">History appears here automatically</span>';
                return;
            }
            strip.innerHTML = hist.map((item, i) => `
                <div class="saved-item" onclick="loadItem(${i})">
                    <strong>${item.name}</strong><br>
                    <span style="font-size:0.9em; opacity:0.7">${new Date(item.time).toLocaleTimeString()}</span>
                </div>
            `).join('');
        }

        function loadItem(i) {
            const hist = loadHistory();
            document.getElementById('mermaid-input').value = hist[i].code;
            document.getElementById('diagram-name').value = hist[i].name;
            renderDiagram();
        }

        // Init
        setTimeout(() => {
            renderHistoryStrip();
            renderDiagram();
        }, 500);

        // Auto-render
        let timeout;
        document.getElementById('mermaid-input').addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(renderDiagram, 1000);
        });
    </script>
</body>

</html>